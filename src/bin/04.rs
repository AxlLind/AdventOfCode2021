use hashbrown::HashSet;

static DRAWS: &[usize] = &[13,79,74,35,76,12,43,71,87,72,23,91,31,67,58,61,96,16,81,92,41,6,32,86,77,42,0,55,68,14,53,26,25,11,45,94,75,1,93,83,52,7,4,22,34,64,69,88,65,66,39,97,27,29,78,5,49,82,54,46,51,28,98,36,48,15,2,50,38,24,89,59,8,3,18,47,10,90,21,80,73,33,85,62,19,37,57,95,60,20,99,17,63,56,84,44,40,70,9,30];
static INPUT: &str = "14 86 50 89 49\n10 85 33 46 87\n82 91 54 13 90\n63 88 75 99 79\n74 31  4  0 71\n\n56  3 70  2 22\n44 63 10 95  8\n92 62 83  4 93\n74 80  5 11 68\n24 50 42 65 72\n\n42 21 72 26  7\n 4 78  1 49 50\n93 43 38 71 68\n62 52 40 61 82\n31 28 16 96 18\n\n46 77 11 86 64\n 4 14 61 94 30\n76 21  7  2 92\n55  1 66 45 23\n65 51 67 26 29\n\n 1 89 70 73 81\n75 40 93 15 60\n11 58 37 42 26\n62 36 20 87 47\n54 35  6 23 10\n\n 2 13 21 69 71\n98 59 82  7 32\n67 90 62 51 19\n84  6 23  3 17\n24 10 25  0 47\n\n28 10 26 86 65\n33 18 21  6 99\n40 61 30 58 34\n29 37 78  4 83\n87 53 44 22 32\n\n19 35 93 78 26\n87 99 15 75 56\n70 22 33 27 24\n58 53 83 48  8\n62 66 18 89 25\n\n30 25 67 77 47\n99  0 44 40 23\n31 19 52 55  7\n65 22 12 27 71\n82 62 54 78 18\n\n17 19 56 93 15\n62 30 64 68 21\n32 84 43 81 51\n61 83 52 65 58\n90 87 31 67 10\n\n95 76 21 10  1\n81 30 64 51 44\n77 31 32 94 90\n58 48 11 43 37\n12 19 82 85 80\n\n79 91 84 44 35\n80  6 64  0 20\n 7 36 33 17 51\n71 19 24 26  2\n75 37 25 59 11\n\n48 91 17 38 16\n54 46 53 33 28\n20  6 68 96 45\n70 75 35 65 59\n 0 39 13 23  4\n\n41 83 90 95 17\n67  4 23 62 93\n31  1 51 21 16\n34 14 92 66 89\n 0 78 58 80 96\n\n67  2 42 36 32\n 1 62 37 65 79\n66 80 19 75  0\n17 86 94 49 54\n40 59 16 14 30\n\n33 70 65  6 20\n44 22 55 81 15\n54  2 13  5  1\n93 40 97 67 78\n30 75 96 41  7\n\n40 96 24 19 32\n88 58 65 34 52\n38 49 50  5 35\n 4 13  2 22 26\n46 55 18 89 33\n\n64 17 54 59 16\n22 97 91 83 87\n 0  3 85 92 43\n99 31 19 73  4\n 8 41 68 48 75\n\n37 45 16 50 57\n31 14 32 77 60\n90 63  3 40  8\n96  6 56 95  2\n80 69 61 52 24\n\n84 50 31  7 40\n32 58 47 51 70\n59 76 44 83 72\n87 52 77 10 81\n57  1 12 37 73\n\n14 74  7 98 95\n78 47  1 22 96\n45 80 92 37 21\n15 10 33 73 63\n29 34 51 27 31\n\n76 21 26 20 22\n89 58 37 91 38\n59  9 74 24 96\n80 69 30  7  0\n70 87 16 78 49\n\n69 79 75 99 65\n20 48 61 29 67\n31 86 90 72 57\n62 83 94 74  1\n34 13 55 56 36\n\n54 52 66 15 29\n 7 16 94 62 92\n50 80  6 24 58\n96 13 93  1  0\n65  3 12 44 76\n\n45 43 51 92 86\n60 70  3 23 69\n63 78 30 66 48\n17 74 81 75 37\n79 53 25 28 15\n\n69 60 98 68 37\n18 39 36 48 75\n50  3 52 11 87\n57 46 63 80 41\n89 12 94 84 25\n\n79 11 64 51 67\n17 47 98 57  5\n16 70 49  0 83\n32 56 84 73 86\n74 59 35 15  6\n\n 6 94 81 28 82\n53 58 43 46 51\n17 20 18 96 41\n66 22 27 12 44\n93 40 78 26 54\n\n28 88 94  9 16\n14 66  2 98 82\n23 69 44 75 10\n38 34 18 51  1\n68 52 29  0 39\n\n11 45 80 94 89\n24 44 96 71 58\n97  2 46 92 12\n47 19 99 55  7\n64 62 72 23 61\n\n99 92 94 38 98\n10 97 40 57 30\n67 77  7 64 23\n88 80 58 78 59\n42 69 68 16 60\n\n68 74 52 73 18\n62 57 49 91 19\n21 48 51 22 70\n45 29 53 75  8\n42 17 20 47 31\n\n76 29 88 23 65\n80  2 90 75 48\n93 55 10 50 81\n74 54  6 89 18\n27 26 84 11 78\n\n69 39 34 79 12\n72 96 80 68 44\n27 57 99 61 64\n81 63  6 25 95\n 8 32 15 74 35\n\n40 38  2 63 21\n28 57 90 19 49\n68 75 11 24 44\n45 50 15 27  9\n31 30 52 33 36\n\n 4 55 11 83 95\n35  0 30 25 45\n73 31 94 22 28\n91 19 50 54 47\n14 90 71 98 23\n\n31 55 45 78 67\n 1 24 51 25 80\n85 96 46 87 64\n37 93 22 59 90\n69 70 50 17 53\n\n20 66 46 83 91\n28 57 99 63  1\n17 59 54 47 55\n50 10 41 53 34\n 3 39 97  9 38\n\n58 29 70 23 95\n96 67 84 59 45\n35 64 63 77 52\n31 14 33 12 78\n17 36 98  0 71\n\n83 68  7  9 75\n13 39  5 99 73\n82 60 14  8 63\n49 86 67 56 91\n62 52 36  1 29\n\n24 65 75 31 63\n48 72 14 70  0\n85 30 42 33 87\n26  8 29  4 96\n93 60 74  9 50\n\n16 98 31 91 43\n90 76 97 18 70\n67  2 45 41 58\n 7  8 26 62 61\n72 21 63 69 17\n\n15 28 96 16 24\n45 41 62 89 67\n57  4 80 23  3\n29 51 99 94 68\n56 37 81 54 63\n\n61 81  6 46 77\n28 43 63 10 41\n76 12 82 23 13\n32 47 94 96 92\n 7 29 69 22 64\n\n68 64 51 69 96\n76 18 88 43 55\n 8 91 73 83 54\n 0 35 94 20 97\n50 29 82 71 75\n\n28 56 92 79 36\n18 85 35 25 26\n51 54 53 21 59\n64 19 17 14 30\n 9 84  5 93 46\n\n58  3  5 76 57\n55 64 79 16 97\n14 59 93 24 60\n84 49 44 69 15\n87 42 43 25 18\n\n 5 90 79 46 80\n41 56 93 15 50\n53 25 95 39  0\n77 89 40 17 92\n 9 73 85 28 42\n\n20 85 78 73 74\n59 12 82 24 52\n55 33 11 28 60\n15 25 61 16 45\n 3 14 39 95 92\n\n82 94 47 30 79\n38 87 15 31 45\n69 63 98 72  1\n77 39 96 81 92\n16 71 80 86  2\n\n38 60 28 94 24\n40 46 67 22 34\n39 70 71  3 96\n27 54 41 69 18\n23 62  1 61 84\n\n74 85 15 44 11\n39 92 43 79  1\n82  8 26  9 57\n20 93 18 97 31\n67 81 17 21 13\n\n54 63 83 89 51\n 0  8 15 25 59\n95 74 18 28 98\n50  3 34 23 77\n 4 24 61 90 88\n\n11 64 61 28 27\n 5 35 74 75 47\n69 84 17 62  9\n40 21 32 73 67\n92 36 12 51 26\n\n35 50  7 26 36\n43 56 42 41 48\n59 54 91 55 33\n37 13 19 20 88\n22 21 51  4 69\n\n93 48  8 94  6\n14 34 13 10 32\n64 90 92 23 15\n63 95 85 28 87\n38  5 91 75 24\n\n94 68 32 85 10\n75 33  0 52 37\n82  8 24 58 93\n49 73 63 44 61\n71 50 16 88 72\n\n93 71 54 20 51\n39 92 75 79 66\n 6 58 52 22 63\n74 53 99 16 61\n29 96 11 83 24\n\n32 26 10 77 16\n31 92 58 44 79\n17  2 72 29  8\n93 38  9 15  3\n50 89 61 88 81\n\n95 65 70 27 79\n 4 19 30 86 72\n80 61 68 74 49\n 7  5 77 14 53\n98 44 51 43 93\n\n59 70 44 52 14\n31 82  9 55 13\n15 63 99 26 61\n34 48 23 56 41\n97 79 28 29 93\n\n26 86 35 66 67\n25 39 48 45 69\n44 93 13 17 81\n70 89 54 62 68\n41 36 90 83 12\n\n92 59 53 11 83\n43 70 30  8 66\n46  6 31 56 90\n62 20 65 94 34\n67 96 47 71 17\n\n34 85 72 51 46\n21  6 44 64 27\n79 86 29 33 35\n 7 87 47 94 84\n62 90 58 80 73\n\n 7 73 50  0 35\n77  6 33 89 94\n71 52 95 53  8\n22  9 46 49 75\n45 56 96 87 67\n\n85 64 44 39 57\n90 30 15 35 54\n78 89 55 99 12\n80 96 20 50 45\n56 10 71 59 17\n\n66 87 77 71 45\n79 65 80 11 88\n74 99 30 89 73\n58 78 64 85 20\n10 41  1 44 49\n\n38 47  3 60 27\n 8 10 14  4  1\n92 24 46 16 95\n55 69 77  7 36\n15 51 13 58 76\n\n61  3 71 38 46\n34 93 42 90 32\n99 16 73 55  6\n48 23 56 12 39\n22 87 51 70 89\n\n 8 58 99 23 56\n91 62 68 57 32\n46 95 21  3 75\n35 51 33  7 74\n26  2 89 76 48\n\n93 89 88 49 55\n11 29 72 27 35\n45  5 46 18 65\n23 32 30 97 42\n76 19 22 77 78\n\n17 43 19  2 42\n20 26 36 68 75\n38 94 37 99 93\n62 46  1 45 89\n59  7 92 78 22\n\n75 41 53 45  7\n91 55 40 31 36\n29 78 90 17 57\n63 20 77 67 42\n64 62 11 48 84\n\n26 89 27 47 91\n15  9 18 62 28\n31 96 42 81 86\n11 52 20 93 38\n83 64 39  1 60\n\n99 48 86 72 92\n38 32 62 18 17\n93 71 76 73 64\n26 36 74 52 68\n24 98 34 88 45\n\n18 84 79 52 42\n54 10 33 90 64\n35  1 78 62 65\n22 48 87 72 50\n56  3 49 20 63\n\n14 50 79 84 49\n17 46 66 80 87\n97 90 24 65 73\n25 30 94 72 99\n78 89 81 96 28\n\n 7 24 96 54 86\n 4 56 83 32 27\n29 91 73 34 45\n16 70  1 39  3\n94 47 44 42 87\n\n44 74 52 65 22\n 5 46 75 27 12\n25 24 43 21 42\n19 80 60 97  3\n 8 84  9 87 94\n\n62 80  7 66 82\n60 79 45  1 75\n55 54 85 64 96\n65  6 16 27 38\n77 26 74 71 91\n\n55 23 59 47 62\n53 92 34 96 58\n38  3 88 46 60\n50 56 83 39 80\n37  6 93  7 94\n\n56 26 45 73 16\n37 30 74 44 64\n53 70 29 21 49\n 4  5 27 92 22\n36  8 63 50 69\n\n70 83 15 22 56\n64 98 32 39 12\n82 21 73 19 14\n44 61 78 26 99\n76 24 81 38 85\n\n56 55 64 39 19\n13 70 63 32 54\n85 22 14 27 73\n25 89 15 44 21\n29 77 79 23 10\n\n84 27 63 34  5\n57 81 78 90 59\n35 85 51 54 48\n92  4 89 70 30\n97  0  7 86 26\n\n 4 44 88 71  6\n80 23 19 55 57\n91  7 18 27 95\n85 13 66  8 34\n63 45 77 17 84\n\n58  7 56 38 48\n92 97 50 80 54\n 5  8 17 49 23\n96 82 20 74  4\n90  0 59 93 30\n\n44 97 88 33 11\n18 69  4  0 94\n13 57 24  9 53\n49  7 68 15 42\n25 39 52  6 98\n\n31 65 59 74 12\n22 39 13  2 16\n44 46 90 60 93\n82  9 71 99 89\n23 80 35 51 41\n\n47 30 75 73 22\n62 87 59 42 90\n 9  5 41 54 32\n71 25 46 24 12\n53 28 77 33 76\n\n36 25  2 74 29\n58 34 44 94 83\n16 72 69 45 28\n88  0 86 14 49\n10 56 24 82 73\n\n27 42 83 51 61\n93 77 33 49 46\n23  5 41 48 90\n81 10  3 16  1\n84 36 40 88 54\n\n60 85  7 28 39\n54 11  4 18 84\n63 95 62 13 82\n93 33 40 16 55\n34 78 29 56 66\n\n51 99 73 14 69\n 3 65 23 60 96\n 1 49 78 55 25\n15 66 11 42 87\n48 52 56 34 38\n\n60 59 65 32 73\n68 76 35 75 42\n72 70 45 34 38\n29 84 28 62 43\n49 85 31 57 23\n\n42 57 40 73 32\n70 79 80 11 67\n55 26 87 92 19\n63 58 78 29 77\n17 74 18 20 60\n\n84 99 72 74 62\n15 14 50 57 77\n48 91 55 46 82\n85 27 33 21 54\n45 31 43 40 60\n\n73 37 66 67 19\n16 79 15 45 89\n84 78 69 28 46\n17  4 12 95 87\n49 99 31  9 36\n\n61 34 98 60 74\n30 95 33 46 64\n73 97 12 26  7\n 2 58 49 70 54\n80 55 94 91 11\n\n27  5  3 62 49\n38 88 40  9 47\n29 59 94 74 12\n48 73 85 97 35\n28 25 30 14 83";

fn board_score(draws: &[usize], b: &[Vec<usize>]) -> usize {
  b.iter().flatten().filter(|x| !draws.contains(x)).sum()
}

fn check_board(draws: &[usize], b: &[Vec<usize>]) -> Option<usize> {
  for i in 0..5 {
    if (0..5).all(|j| draws.contains(&b[i][j])) {
      return Some(board_score(draws, b) * draws.last().unwrap());
    }
    if (0..5).all(|j| draws.contains(&b[j][i])) {
      return Some(board_score(draws, b) * draws.last().unwrap());
    }
  }
  None
}

fn part1(boards: &[Vec<Vec<usize>>]) -> usize {
  for i in 5..DRAWS.len() {
    let winner = boards.iter()
      .find_map(|b| check_board(&DRAWS[0..i], b));
    if let Some(score) = winner {
      return score;
    }
  }
  unreachable!()
}

fn part2(boards: &[Vec<Vec<usize>>]) -> usize {
  let mut boards = boards.iter().collect::<HashSet<_>>();
  for i in 5..DRAWS.len() {
    let winners = boards.iter()
      .filter_map(|&b| check_board(&DRAWS[0..i], b).map(|score| (b,score)))
      .collect::<Vec<_>>();
    for (b,_) in &winners {
      boards.remove(b);
    }
    if boards.is_empty() {
      return winners[0].1;
    }
  }
  unreachable!()
}

aoc2021::main! {
  let boards = INPUT.split("\n\n")
    .map(|b| b.lines()
      .map(|l| l.split_whitespace().map(|i| i.parse().unwrap()).collect())
      .collect()
    )
    .collect::<Vec<_>>();
  (part1(&boards), part2(&boards))
}
